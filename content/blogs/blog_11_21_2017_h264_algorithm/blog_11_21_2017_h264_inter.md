Title: H264 Motion Estimation & Inter Prediction
Date: 2017-11-20
Category: Technology  
Tags: Video Codec, h264
Slug: h264_inter_algorithm

#### __Introduction__
***
Inter prediction creates a prediction model from one or more previously encoded video frames. The model is formed by shifting samples in the reference frame(s) (motion compensated prediction). The AVC CODEC uses block-based motion compensation, the same principle adopted by every major coding standard since H.261. Important differences from earlier standards include the support for a range of block sizes (down to 4x4) and fine sub-pixel motion vectors (1/4 pixel in the luma component).

#### __Tree Structured Motion Compensation__
***
AVC supports motion compensation block sizes ranging from 16x16 to 4x4 luminance samples with many options between the two. The luminance component of each macroblock (16x16 samples) may be split up in 4 ways: 16x16, 16x8, 8x16 or 8x8. Each of the sub-divided regions is a macroblock partition. _If the 8x8 mode is chosen_, each of the four 8x8 macroblock partitions within the macroblock may be split in a further 4 ways: 8x8, 8x4, 4x8 or 4x4 (known as macroblock sub-partitions). These partitions and sub-partitions give rise to a large number of possible combinations within each macroblock. This method of partitioning macroblocks into motion compensated sub-blocks of varying size is known as tree structured motion compensation.

![Photo]({attach}/blogs/blog_11_21_2017_h264_algorithm/h264_inter_tree.png){width=80%}

A separate motion vector is required for each partition or sub-partition. Each motion vector must be coded and transmitted; in addition, the choice of partition(s) must be encoded in the compressed bitstream. Choosing a large partition size (e.g. 16x16, 16x8, 8x16) means that a small number of bits are required to signal the choice of motion vector(s) and the type of partition; however, the motion compensated residual may contain a significant amount of energy in frame areas with high detail. Choosing a small partition size (e.g. 8x4, 4x4, etc.) may give a lower-energy residual after motion compensation but requires a larger number of bits to signal the motion vectors and choice of partition(s). The choice of partition size therefore has a significant impact on compression performance. In general, a large partition size is appropriate for homogeneous areas of the frame and a small partition size may be beneficial for detailed areas.

The resolution of each chroma component in a macroblock (Cr and Cb) is half that of the luminance (luma) component. Each chroma block is partitioned in the same way as the luma component, except that the partition sizes have exactly half the horizontal and vertical resolution (an 8x16 partition in luma corresponds to a 4x8 partition in chroma; an 8x4 partition in luma corresponds to 4x2 in chroma; and so on). The horizontal and vertical components of each motion vector (one per partition) are halved when applied to the chroma blocks.

#### __Sub-pixel Motion Vectors__
***
The accuracy of motion compensation is in units of one quarter of the distance between luma samples. In case the motion vector points to an integer-sample position, the prediction signal consists of the corresponding samples of the reference picture; otherwise the corresponding sample is obtained using interpolation to generate noninteger positions. The prediction values at half-sample positions are obtained by applying a one-dimensional 6-tap FIR filter horizontally and vertically. Prediction values at quarter-sample positions are generated by averaging samples at integer- and half-sample positions.

![Photo]({attach}/blogs/blog_11_21_2017_h264_algorithm/h264_inter_subpixel.png){width=40%}

The 6-tap filter as follow:

$b_1 = (E-5F+20G+20H-5I+J)$

$h_1 = (A-5C+20G+20M-5R+T)$

The final prdiction value for $b$ and $h$ are obtained as follows and clipped to range 0-255:

$b=(b_1 + 16)>>5$

$h=(h_1 + 16)>>5$

The samples at half sample positions j are obtained by:

$j_1 = cc - 5dd + 20h_1 + 20m_1 - 5ee + ff$

$j = (j_1 + 512)>>10$

The samples at quarter sample positions labeled as a,c,d,n,f,i,k and q are derived by :

$a = (G + b + 1)>>1$

$e = (b + h + 1)>>1$

















