Title: x264 Overview
Date: 2017-11-14 22:29
Category: Technology  
Tags: Video Codec, x264 
Slug: x264_overview 

### __Introduction__
***
x264 version compilable by visual studio, generated by [Shift Media Project](https://shiftmediaproject.github.io/) I have forked my own version and put it in my github website: git@github.com:huyunf/x264.git

### **Code Overview**
***
    h = x264_encoder_open( );

    for(loop by frame number){
        ...
        encode_frame( );
        ...
    }

The `x264_encoder_open()` function does several initial task for the following encoding process. For more detail, please refer to [x264 Encoder Open]({filename}/blogs/blog_11_20_2017_x264_1_encoder_open/blog_11_20_2017_x264_1_encoder_open.md) 

The `encode_frame()` will lead to `x264_encoder_encode`, which is the true main encoding funcion. In `x264_encoder_encode`, it 

1. prepare thread for encoding task
2. setup new frame from picture list

    * setting frame parameters like resolution, picture structure. etc
    * initial parameters for <span style="color:green;">adaptive MB level quantization</span> by calling function `x264_adaptive_quant_frame`. For detail algorithm please refer to [x264 Adaptive Quant]({filename}/blogs/blog_12_06_2017_x264_adaptive_quant/blog_12_06_2017_x264_adaptive_quant.md)
    * prepare low resolution frame for zero pass `x264_frame_init_lowres`
    * put frame into process queue `x264_lookahead_put_frame`. If enable multiple thread, each thread will get frame from the list and start their own process
    
    The prepare process should fill the <span style="color:green;">prepare frame list</span>. And the number of frame need to input to the list is decided by
    
            if( h->frames.i_input <= h->frames.i_delay + 1 - h->i_thread_frames )
            {
                ...
                return 0;
            }
    
3. analyze picture in lookahead `x264_lookahead_get_frames`, mainly for get slice type
    * decide slice type `x264_slicetype_decide`. For more detail about the x264 slice type decision algorithm. Please refer to [x264 Slice Type Decision]({filename}/blogs/blog_12_06_2017_x264_slice_type_decision/blog_12_06_2017_x264_slice_type_decision.md)

4. several top level syntax process, like reference list prepare `x264_reference_build_list`, nal structure prepare. etc

5. bit stream structure bs prepare `bs_init`, write header if necessary:
    * aud
    * if key frame, write SPS and PPS
    * period sei, extra sei, pic timing sei, sei for blu-ray. etc

6. perform rate control `x264_ratecontrol_start` and get the global qp `x264_ratecontrol_qp`. For more detail of x264 rate control, please refer to [x264 rate control]({filename}/blogs/blog_12_05_2017_x264_rate_control/blog_12_05_2017_x264_rate_control.md)

7. initial slice header `x264_slice_init`

8. weighted prediction prepare `x264_macroblock_bipred_init` and `x264_weighted_pred_init`

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    